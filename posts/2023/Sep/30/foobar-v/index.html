
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://mestrace.github.io/theme/stylesheet/style.less" rel="stylesheet/less" type="text/css"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>
<link href="https://mestrace.github.io/theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/theme/pygments/monokai.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://mestrace.github.io/static/custom.css" rel="stylesheet" type="text/css"/>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/site.webmanifest" rel="manifest"/>
<!-- Chrome, Firefox OS and Opera -->
<meta content="#333" name="theme-color"/>
<!-- Windows Phone -->
<meta content="#333" name="msapplication-navbutton-color"/>
<!-- iOS Safari -->
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<!-- Microsoft EDGE -->
<meta content="#333" name="msapplication-TileColor"/>
<link href="https://mestrace.github.io/feeds/all.atom.xml" rel="alternate" title="Mestrace的个人博客 Atom" type="application/atom+xml"/>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-07WBTMQT81"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-07WBTMQT81');
</script>
<meta content="Mestrace" name="author">
<meta content="接上回书，我们来到了Foobar挑战的第五层，题目越来越困难了。本题主要涉及一些数论和组合数学的知识点。" name="description">
<meta content="Google Foobar" name="keywords"/>
<meta content="Mestrace的个人博客" property="og:site_name">
<meta content="解决Foobar挑战（四）- 终篇" property="og:title">
<meta content="接上回书，我们来到了Foobar挑战的第五层，题目越来越困难了。本题主要涉及一些数论和组合数学的知识点。" property="og:description">
<meta content="en_US" property="og:locale">
<meta content="https://mestrace.github.io/posts/2023/Sep/30/foobar-v/" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2023-09-30 21:00:00+08:00" property="article:published_time"/>
<meta content="2023-10-09 22:00:00+08:00" property="article:modified_time"/>
<meta content="https://mestrace.github.io/author/mestrace.html" property="article:author"/>
<meta content="MISC" property="article:section">
<meta content="Google Foobar" property="article:tag"/>
<meta content="http://github.com/Mestrace.png?size=460" property="og:image"/>
<title>Mestrace的个人博客 – 解决Foobar挑战（四）- 终篇</title>
</meta></meta></meta></meta></meta></meta></meta><link href="https://mestrace.github.io/posts/2023/Sep/30/foobar-v/" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Mestrace的个人博客", "item": "https://mestrace.github.io"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://mestrace.github.io/posts"}, {"@type": "ListItem", "position": 3, "name": "2023", "item": "https://mestrace.github.io/posts/2023"}, {"@type": "ListItem", "position": 4, "name": "Sep", "item": "https://mestrace.github.io/posts/2023/Sep"}, {"@type": "ListItem", "position": 5, "name": "30", "item": "https://mestrace.github.io/posts/2023/Sep/30"}, {"@type": "ListItem", "position": 6, "name": "Foobar v", "item": "https://mestrace.github.io/posts/2023/Sep/30/foobar-v"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://mestrace.github.io/posts/2023/Sep/30/foobar-v/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Mestrace"}, "publisher": {"@type": "Organization", "name": "Mestrace的个人博客"}, "headline": "解决Foobar挑战（四）- 终篇", "about": "MISC", "datePublished": "2023-09-30 21:00"}</script></head>
<body>
<aside>
<div>
<a href="https://mestrace.github.io/">
<img alt="Mestrace" src="http://github.com/Mestrace.png?size=460" title="Mestrace"/>
</a>
<h1>
<a href="https://mestrace.github.io/">Mestrace</a>
</h1>
<p>Software Developer</p>
<nav>
<ul class="list">
<li>
<a href="https://mestrace.github.io/pages/about.html" target="_self">
                About
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="http://github.com/Mestrace/" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="https://mestrace.github.io/">Home</a>
<a href="https://mestrace.github.io/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="foobar-v">解决Foobar挑战（四）- 终篇</h1>
<p>
      Posted on Sat 30 September 2023 in <a href="https://mestrace.github.io/category/misc.html">MISC</a>
</p>
</header>
<div>
<p>Foobar系列已经全部完成了，你可以通过以下目录访问！</p>
<ul>
<li><a href="https://mestrace.github.io/posts/2023/Apr/21/foobar-ii/">解决Foobar挑战（一）</a></li>
<li><a href="https://mestrace.github.io/posts/2023/Apr/22/foobar-iii/">解决Foobar挑战（二）</a></li>
<li><a href="https://mestrace.github.io/posts/2023/May/13/foobar-iv/">解决Foobar挑战（三）</a></li>
<li>解决Foobar挑战（四）- 终篇</li>
</ul>
<h2>Dodge the Lasers!</h2>
<div class="highlight"><pre><span></span><code><span class="nv">foobar</span>:<span class="o">~/</span><span class="w"> </span><span class="nv">mestrace</span>$<span class="w"> </span><span class="nv">request</span>
<span class="nv">Requesting</span><span class="w"> </span><span class="nv">challenge</span>...
<span class="nv">Huzzah</span><span class="o">!</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">famous</span><span class="w"> </span><span class="nv">pilots</span><span class="w"> </span><span class="nv">Luke</span><span class="w"> </span><span class="nv">Skybunny</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">Jyn</span><span class="w"> </span><span class="nv">Erbun</span><span class="w"> </span><span class="nv">managed</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">hijack</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">Commander</span><span class="w"> </span><span class="nv">Lambda</span><span class="s1">'s starfighters and are laying down cover fire for the bunnies'</span><span class="w"> </span><span class="nv">escape</span><span class="w"> </span><span class="nv">pods</span>.<span class="w"> </span><span class="nv">You</span><span class="w"> </span><span class="nv">give</span><span class="w"> </span><span class="nv">them</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">wing</span><span class="w"> </span><span class="nv">salute</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">way</span><span class="w"> </span><span class="nv">past</span>.

<span class="nv">New</span><span class="w"> </span><span class="nv">challenge</span><span class="w"> </span><span class="s2">"Dodge the Lasers!"</span><span class="w"> </span><span class="nv">added</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">home</span><span class="w"> </span><span class="nv">folder</span>.
<span class="nv">Time</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">solve</span>:<span class="w"> </span><span class="mi">528</span><span class="w"> </span><span class="nv">hours</span>.
</code></pre></div>
<p>看到这个528小时（22天）的限时我就觉得隐隐约约有些不对劲……</p>
<details>
<summary>题目</summary>
<p>Oh no! You've managed to escape Commander Lambda's collapsing space station in an escape pod with the rescued bunny workers - but Commander Lambda isnt about to let you get away that easily. Lambda sent an elite fighter pilot squadron after you -- and they've opened fire!</p>
<p>Fortunately, you know something important about the ships trying to shoot you down. Back when you were still Lambda's assistant, the Commander asked you to help program the aiming mechanisms for the starfighters. They undergo rigorous testing procedures, but you were still able to slip in a subtle bug. The software works as a time step simulation: if it is tracking a target that is accelerating away at 45 degrees, the software will consider the targets acceleration to be equal to the square root of 2, adding the calculated result to the targets end velocity at each timestep. However, thanks to your bug, instead of storing the result with proper precision, it will be truncated to an integer before adding the new velocity to your current position.  This means that instead of having your correct position, the targeting software will erringly report your position as sum(i=1..n, floor(i*sqrt(2))) - not far enough off to fail Commander Lambdas testing, but enough that it might just save your life.</p>
<p>If you can quickly calculate the target of the starfighters' laser beams to know how far off they'll be, you can trick them into shooting an asteroid,
releasing dust, and concealing the rest of your escape.  Write a function solution(str_n) which, given the string representation of an integer n, returns the
sum of (floor(1<em>sqrt(2)) + floor(2</em>sqrt(2)) + ... + floor(n<em>sqrt(2))) as a string. That is, for every number i in the range 1 to n, it adds up all of the
integer portions of i</em>sqrt(2).</p>
<p>For example, if str_n was "5", the solution would be calculated as
floor(1<em>sqrt(2)) +
floor(2</em>sqrt(2)) +
floor(3<em>sqrt(2)) +
floor(4</em>sqrt(2)) +
floor(5*sqrt(2))
= 1+2+4+5+7 = 19
so the function would return "19".</p>
<p>str_n will be a positive integer between 1 and 10^100, inclusive. Since n can be very large (up to 101 digits!), using just sqrt(2) and a loop won't work. Sometimes, it's easier to take a step back and concentrate not on what you have in front of you, but on what you don't.</p>
</details>
<p>跟之前的套路一样，首先题目先给出了一个冗长的描述。其实主要意思是说计算 <span class="math">\(S(n) = \sum_{i=1}^{n} \lfloor i\sqrt{2} \rfloor\)</span>。再搂一眼数据范围…… 嚯，好家伙，直接给了<code>1 &lt;= n &lt;= 10^100</code>的数据范围。明摆着用<code>for</code>循环解决不了。但我们还是可以用这个朴素方法来作为标准答案。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<p>那么，接下来有没有什么办法能够让我大幅度减少以上算法的复杂度呢？经过一番搜索，我找到了这个<a href="https://en.wikipedia.org/wiki/Beatty_sequence">Beatty 序列</a>！</p>
<p>Beatty-Rayleigh定理：若 <span class="math">\(\alpha, \beta \in \mathbb{R}^+\)</span>，且 <span class="math">\(\alpha, \beta \notin \mathbb{Q}\)</span>，使得
<span class="math">\(\frac{1}{\alpha} + \frac{1}{\beta} = 1\)</span>，则有两个集合
<span class="math">\(P = \left\{ \lfloor \alpha n \rfloor : n \in \mathbb{Z}^+ \right\}\)</span> 和 <span class="math">\( Q = \left\{ \lfloor \beta n \rfloor : n \in \mathbb{Z}^+ \right\}\)</span>，且 <span class="math">\(P\)</span> 和 <span class="math">\(Q\)</span> 完整划分整个自然数集合
<span class="math">\(P \cap Q = \emptyset\)</span>，以及 <span class="math">\(P \cup Q = \mathbb{Z}^+\)</span>。</p>
<p>当<span class="math">\(\alpha = \sqrt{2}\)</span>，<span class="math">\(\beta=2 + \sqrt{2}\)</span>时，我们有</p>
<table>
<thead>
<tr>
<th>i</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="math">\(\lfloor \alpha i \rfloor\)</span><sup id="sf-foobar-v-1-back"><a class="simple-footnote" href="#sf-foobar-v-1" title="OEIS A001951">1</a></sup></td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>5</td>
<td>7</td>
<td>8</td>
</tr>
<tr>
<td><span class="math">\(\lfloor \beta i \rfloor\)</span><sup id="sf-foobar-v-2-back"><a class="simple-footnote" href="#sf-foobar-v-2" title="OEIS A001952">2</a></sup></td>
<td>3</td>
<td>6</td>
<td>10</td>
<td>13</td>
<td>17</td>
<td>20</td>
<td>23</td>
</tr>
</tbody>
</table>
<p align="center">
<img src="https://mestrace.github.io/images/where_sold.jpg"/>
</p>
<p>通过Beatty-Rayleigh定理反推，给定一个正整数 <span class="math">\(n\)</span>，我们想要计算 <span class="math">\(P_n\)</span>，则可以表示为 <span class="math">\(\sum{P_n} = \sum{\mathcal{Z}} - \sum{Q_m}\)</span>。其中，<span class="math">\(P_n\)</span> 和 <span class="math">\(Q_m\)</span> 共同组成了自然数集合 <span class="math">\({1,2,3,...,\lfloor \alpha i \rfloor}\)</span> 。需要注意的是，我们使用变量 <span class="math">\(m\)</span> 和 <span class="math">\(n\)</span> 分别代表前述两个集合的最大值。从上面的例子我们可以观察到，当<code>i</code>相同时，集合 <span class="math">\(P\)</span> 和 <span class="math">\(Q\)</span> 的最大值范围是不一样的，因此他们所圈选的自然数空间也不一样。我们可以通过计算 <span class="math">\(m = \lfloor \alpha i \rfloor / \beta\)</span> 来限制 <span class="math">\(Q\)</span> 的取值范围。接着我们就可以递归计算 <span class="math">\(Q_m\)</span>。因为 <span class="math">\(m\)</span> 每次都会变小，我们期望他能够收敛到这个递归方程的基线条件，即 <span class="math">\(m = 0\)</span> 或者 <span class="math">\(m = 1\)</span> 。以下为代码实现。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="k">def</span> <span class="nf">sum_beatty_v2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sum_beatty_v2</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="n">beta</span><span class="p">),</span> <span class="n">beta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">solution_v2</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sum_beatty_v2</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span>
</code></pre></div>
<p>实现完成，现在让我们debug一下，打印出来每次递归的值看看吧！</p>
<div class="highlight"><pre><span></span><code>&gt; solution_v2("10")

10 1.4142135623730951
4 3.4142135623730945
9 1.4142135623730951
3 3.4142135623730945
7 1.4142135623730951
2 3.4142135623730945
4 1.4142135623730951
1 3.4142135623730945

'73'
</code></pre></div>
<p>每次递归的<code>n</code>是减小了，但数量级没变小，那么时间复杂度还是没有变化啊！不过，我们可以观察到，每次都是 <span class="math">\(\alpha\)</span> 和 <span class="math">\(\beta\)</span> 不停的在 <span class="math">\(\sqrt 2\)</span> 和 <span class="math">\(2 + \sqrt 2\)</span> 之间互换。每次在 <span class="math">\(\alpha = \sqrt 2\)</span> 的时候，<code>n</code>都会减半，如果我们能让 <span class="math">\(\alpha = 2 + \sqrt 2\)</span> 的量级变小就好了……</p>
<p align="center">
<img src="https://mestrace.github.io/images/cong-tian-er-jiang.jpg"/>
</p>
<p>我们直接做一个展开，当 <span class="math">\(\alpha = 2 + \sqrt 2\)</span> 时，<span class="math">\(P_n = {\lfloor 2 + \sqrt 2\rfloor, \lfloor 4 + 2\sqrt 2 \rfloor ,...,\lfloor n (2 + \sqrt 2)}\)</span>。如果我们把其中的整数项提出来，其实是不影响向下取整的结果的。</p>
<p>定理2: 若 <span class="math">\(\alpha, \in \mathbb{R}^+\)</span>，<span class="math">\(\alpha, \notin \mathbb{Q}\)</span> ，且 <span class="math">\(\alpha &gt; 1\)</span> ， <span class="math">\(\beta = \alpha - 1\)</span>，则有两个集合
<span class="math">\(P = \left\{ \lfloor \alpha n \rfloor : n \in \mathbb{Z}^+ \right\}\)</span> 和 <span class="math">\( Q = \left\{ \lfloor \beta n \rfloor : n \in \mathbb{Z}^+ \right\}\)</span>，使得 <span class="math">\(\sum_{P} = \sum_{i = 1}^n{i} + \sum_{Q}\)</span>。</p>
<p>我们可以利用这个定理来进一步化简我们的算法。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="k">def</span> <span class="nf">nsum</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">sum_beatty_v3</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">alpha</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">nsum</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nsum</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_beatty_v3</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">solution_v3</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sum_beatty_v3</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&gt; solution_v3("1000")

1000
414
171
70
28
11
4
1

'707314'
</code></pre></div>
<p>从数学上的定义来说，我们似乎已经有一个完备的程序来计算这道题目的结果了。但我们可能忽略了一个重要的问题 ---- 浮点数精度问题。我们可以注意到，在上述程序中，我们一直使用一个<code>sqrt(2)</code>的浮点数来计算，但是当数据大小扩大到<code>10^100</code>的级别，使用浮点数会引起两个问题：随着数据范围的增大，浮点数的表示精度会下降，且乘法的算数精度会下降。最终这两者结合起来会引起我们算出来的结果不对。因此，我们要用精确的<code>sqrt(2)</code>表示。这里我用<code>decimal</code>和基本的浮点数生成了结果对比。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">decimal</span>

<span class="c1"># Set the precision to a sufficiently high value</span>
<span class="n">decimal</span><span class="o">.</span><span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># You can adjust the precision as needed</span>

<span class="c1"># Calculate sqrt(2)</span>
<span class="n">sqrt_2</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

<span class="c1"># Set the value of n</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># You can replace this with the desired value of n</span>

<span class="c1"># Calculate sqrt(2) * 10^n</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sqrt_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">sqrt_2_integer</span><span class="p">)</span>
<span class="mi">14142135623730950488016887242096980785696718753769480731766797379907324784621070388503875343276415727</span>
<span class="o">&gt;</span> <span class="nb">int</span><span class="p">((</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e100</span><span class="p">))</span>
<span class="mi">14142135623730952214093017858547657902953555641438782124185842940740828094528952769132495248707026944</span>
</code></pre></div>
<p>可以观察到，在第<code>15</code>位的时候已经有差别了。</p>
<p>考虑到我们其实只需要计算<code>sqrt(2) - 1</code>因此我们截取小数部分，并预计算到100位，最后使用整数乘法和除法计算以保存精度。</p>
<p>此外，别忘了Foobar采用的是Python2，因此一些语法需要额外处理。这里给出我的最终版本。</p>
<div class="highlight"><pre><span></span><code><span class="n">msqrt</span> <span class="o">=</span> <span class="mi">4142135623730950488016887242096980785696718753769480731766797379907324784621070388503875343276415727</span>

<span class="k">def</span> <span class="nf">get_n1</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">msqrt</span> <span class="o">*</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">10</span><span class="o">**</span><span class="mi">100</span>

<span class="k">def</span> <span class="nf">solution_v4</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sum_beatty_v4</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">nsum</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">sum_beatty_v4</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">get_n1</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nsum</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nsum</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_beatty_v4</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
</code></pre></div>
<p>如果你对Beatty数列及相关概念感兴趣，我非常推荐阅读以下两篇文章：</p>
<ul>
<li><a href="https://www.cnblogs.com/emofunc/p/14892665.html">Beatty序列与Wythoff博弈 </a></li>
<li><a href="http://www.matrix67.com/blog/archives/6784">捡石子游戏、 Wythoff 数表和一切的 Fibonacci 数列</a></li>
</ul>
<h2>Fin</h2>
<p>提交完最后一题，我长舒了一口气。在熟悉的命令行里输入了<code>status</code>，却出现了新的谜题……</p>
<div class="highlight"><pre><span></span><code>foobar:~/<span class="w"> </span>mestrace$<span class="w"> </span>status
You've<span class="w"> </span>completed<span class="w"> </span>all<span class="w"> </span>the<span class="w"> </span>levels!!

<span class="nt">&lt;encrypted&gt;</span>b'FkIAARECBhYeQlNOUkYEFwgEB1NeQUQGAgkfERMGFgBKRUlUVQQQEQgAHhEWRk9FSgAVEh0TFxZK\nRUlUVQgNBh8AFx0QDQZCQUVUFREJCgAbAB4RHBVERVdFVAEcDQwGBgAXU15BRBcMBxEdBhJERVdF\nVAcTBwZCQUVUEh0OREVXRVQDGw9CQhA='<span class="nt">&lt;/encrypted&gt;</span>

For<span class="w"> </span>your<span class="w"> </span>*eyes*<span class="w"> </span>only!

Use<span class="w"> </span>the<span class="w"> </span>status<span class="w"> </span>command<span class="w"> </span>to<span class="w"> </span>repeat<span class="w"> </span>this<span class="w"> </span>message.
</code></pre></div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js','color.js','mhchem.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script><ol class="simple-footnotes"><li id="sf-foobar-v-1"><a href="https://oeis.org/A001951">OEIS A001951</a> <a class="simple-footnote-back" href="#sf-foobar-v-1-back">↩</a></li><li id="sf-foobar-v-2"><a href="https://oeis.org/A001952">OEIS A001952</a> <a class="simple-footnote-back" href="#sf-foobar-v-2-back">↩</a></li></ol>
</div>
<div class="tag-cloud">
<p>
<a href="https://mestrace.github.io/tag/google-foobar.html">Google Foobar</a>
</p>
</div>
<div class="center social-share">
<p>如果你觉得这篇文章很赞，不要忘记分享给你的小伙伴们！</p>
<div class="addthis_native_toolbox"></div>
<div class="addthis_sharing_toolbox"></div>
<div class="addthis_inline_share_toolbox"></div>
</div>
<div class="addthis_relatedposts_inline"></div>
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="https://mestrace.github.io/theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Mestrace的个人博客 ",
  "url" : "https://mestrace.github.io",
  "image": "http://github.com/Mestrace.png?size=460",
  "description": "我的个人博客，记录我的成长历程"
}
</script><script async="async" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-64172c2607a4b50c" type="text/javascript"></script>
<a aria-label="View source on Github" class="github-corner" href="http://github.com/Mestrace/" target="_blank">
<svg aria-hidden="true" height="80" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" viewbox="0 0 250 250" width="80">
<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
<path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;">
</path>
<path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor">
</path>
</svg>
</a>
</body>
</html>